<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Status - My Two Minutes Food</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 font-sans">

  <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg mt-6">
    <h1 class="text-3xl font-bold mb-6 text-orange-600">Order Status</h1>

    <div id="orderDetails" class="space-y-6">
      <!-- Order Summary Section -->
      <div class="bg-gray-50 p-4 rounded border">
        <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
        <div id="orderItems" class="space-y-4"></div>
        <div class="flex justify-between text-lg font-semibold mt-2">
          <span>Total:</span>
          <span id="orderTotal">R0.00</span>
        </div>
      </div>

      <!-- Order Status Section -->
      <div class="bg-gray-50 p-4 rounded border mt-6">
        <h2 class="text-xl font-semibold mb-4">Current Status</h2>
        <div id="orderStatus" class="text-lg font-semibold text-orange-600">Loading...</div>
      </div>
      
      <!-- Map Section -->
      <div id="orderMap" class="mt-6">
        <div class="w-full h-64" id="map"></div>
      </div>

      <!-- Back to Home Button -->
      <div class="mt-6 text-center">
        <a href="index.html" class="bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600">Back to Home</a>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxBT0oESoL62oz_x_Z8cMtdENWZPx4tMI",
      authDomain: "pinotp-d7ef5.firebaseapp.com",
      databaseURL: "https://pinotp-d7ef5-default-rtdb.firebaseio.com",
      projectId: "pinotp-d7ef5",
      storageBucket: "pinotp-d7ef5.appspot.com",
      messagingSenderId: "708458917827",
      appId: "1:708458917827:web:8b8cc6de6176f936cf9776"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');
    const orderDetailsContainer = document.getElementById('orderDetails');
    const orderItemsContainer = document.getElementById('orderItems');
    const orderTotalEl = document.getElementById('orderTotal');
    const orderStatusEl = document.getElementById('orderStatus');
    const orderMapContainer = document.getElementById('orderMap');

    const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';

    async function fetchOrderDetails() {
      const orderRef = ref(db, `orders/${orderId}`);
      try {
        const snapshot = await get(orderRef);
        if (snapshot.exists()) {
          const orderData = snapshot.val();

          // Render Order Items
          let total = 0;
          orderItemsContainer.innerHTML = '';
          orderData.cart.forEach(c => {
            const itemEl = document.createElement('div');
            itemEl.className = 'flex justify-between';
            const itemTotal = c.item.price * c.quantity;
            itemEl.innerHTML = ` 
              <span class="font-semibold">${c.item.name}</span>
              <span class="text-orange-600 font-semibold">R${itemTotal.toFixed(2)}</span>
            `;
            orderItemsContainer.appendChild(itemEl);
            total += itemTotal;
          });

          orderTotalEl.textContent = `R${(total + orderData.deliveryFee - orderData.discount).toFixed(2)}`;

          // Render Order Status
          orderStatusEl.textContent = orderData.status;

          // Render Map Location (If Available)
          if (orderData.address) {
            const geocodeUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${orderData.address}.json?access_token=${MAPBOX_ACCESS_TOKEN}&limit=1`;
            const response = await fetch(geocodeUrl);
            const mapData = await response.json();
            if (mapData.features && mapData.features.length > 0) {
              const [longitude, latitude] = mapData.features[0].geometry.coordinates;

              mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
              const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [longitude, latitude],
                zoom: 14
              });

              new mapboxgl.Marker()
                .setLngLat([longitude, latitude])
                .addTo(map);
            }
          }
        } else {
          orderStatusEl.textContent = "Order not found.";
        }
      } catch (error) {
        console.error("Error fetching order data:", error);
        orderStatusEl.textContent = "There was an error fetching your order details.";
      }
    }

    fetchOrderDetails();
  </script>

</body>
</html>
